#!/bin/bash

# Filename: check_inspector_vulnerability_scan.sh

YEAR=$(date +'%Y')
DATE=$(date +%F)
DIR="lists/$YEAR/inspector"

# Ensure the directory exists
mkdir -p $DIR

# List and describe assessment targets
assessment_targets=$(aws inspector list-assessment-targets --query 'assessmentTargetArns' --output json)
echo $assessment_targets | jq . > $DIR/assessment_targets.json

for target_arn in $(echo $assessment_targets | jq -r '.[]'); do
    echo "Describing Assessment Target: $target_arn"
    aws inspector describe-assessment-targets --assessment-target-arns $target_arn --output json > $DIR/$DATE.assessment_target_$(basename $target_arn).json
done

# List and describe assessment templates
assessment_templates=$(aws inspector list-assessment-templates --query 'assessmentTemplateArns' --output json)
echo $assessment_templates | jq . > $DIR/assessment_templates.json

for template_arn in $(echo $assessment_templates | jq -r '.[]'); do
    echo "Describing Assessment Template: $template_arn"
    aws inspector describe-assessment-templates --assessment-template-arns $template_arn --output json > $DIR/$DATE.assessment_template_$(basename $template_arn).json
done

# List and describe findings
for template_arn in $(echo $assessment_templates | jq -r '.[]'); do
    echo "Processing Findings for Template: $template_arn"
    for run_arn in $(aws inspector list-runs --assessment-template-arns $template_arn --query 'runArns' --output text); do
        echo "Listing Findings for Run: $run_arn"
        findings=$(aws inspector list-findings --assessment-run-arns $run_arn --output json)
        echo $findings | jq . > $DIR/$DATE.findings_$(basename $run_arn).json
    done
done

echo "Inspector vulnerability scan configuration and findings have been written to JSON files in $DIR."
